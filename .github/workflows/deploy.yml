name: Deploy to Production

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  # ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰ - Android
  deploy-android:
    name: Deploy Android to Play Store
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.12.0

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ğŸ—ï¸ Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ”¨ Build Android AAB
        run: eas build --platform android --profile production --non-interactive

      - name: ğŸ“¤ Submit to Play Store
        run: eas submit --platform android --profile production --non-interactive
        env:
          GOOGLE_SERVICE_ACCOUNT_KEY: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}

  # ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰ - iOS
  deploy-ios:
    name: Deploy iOS to App Store
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.12.0

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ğŸ—ï¸ Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ Build iOS
        run: eas build --platform ios --profile production --non-interactive

      - name: ğŸ“¤ Submit to App Store
        run: eas submit --platform ios --profile production --non-interactive
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}

  # ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆä½œæˆ
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [deploy-android, deploy-ios]
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“ Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          body: |
            ## ğŸ‰ Y!mobile Monitor ${{ github.ref_name }}
            
            ### âœ¨ æ–°æ©Ÿèƒ½
            - ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆæ©Ÿèƒ½ï¼ˆAndroid & iOSï¼‰
            - ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨é‡ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º
            - ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰è‡ªå‹•æ›´æ–°
            
            ### ğŸ“± ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            - Android: Google Play Store
            - iOS: App Store
            
            ### ğŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
            è©³ç´°ã¯ [README.md](https://github.com/${{ github.repository }}/blob/main/README.md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
          draft: false
          prerelease: false
